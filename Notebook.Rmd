---
title: ' '
output:
  html_document:
    number_sections: false
    theme: cosmo
    highlight: monochrome
    toc: FALSE
    toc_float : FALSE
    toc_depth : 2
    css: R_mesure_Marianne.css
    df_print: kable
  geometry: margin=0.1cm
  pdf_document: default
editor_options: 
  chunk_output_type: inline
---
# Rapport stage prévision 


```{r package, include=FALSE}
library(haven)
library(dplyr)
library(utils)
library(forecast)
library(urca)
library(readxl)
library(tidyverse)
library(ggplot2) #pour le graphe
library(knitr)
library(RJDemetra)
source("function.R")
```

## Avancée et première prévision

J'ai utilisé le package RJDemetra conseillé par Eurostat. Il propose deux modèles : le modème TRAMO-SEATS et le modèle X13-ARIMA. Je me suis tout d'abord concentré sur le modèle X13 qui permet de désaisonnaliser les séries et de faire des prévisions assez rapidement. J'ai utilisé les données à partir de 2016 pour éviter le creux de 2015 et ne pas utiliser la série longue (déconseillé lorsque l'on fait des précvisions). Ce package m'a aussi permis d'interpréter la période COVID comme des outliers, après avoir tester plusieurs modèles, il est équivalent de considérer tous les données de la période COVID (d'avril 2020 à mai 2021) comme des TC (temporary change) ou de considérer la prémière chute d'avril à juin 2020 comme un AO (additive outlier) et le reste de la période comme des TC. 




```{r plot_x13, echo=FALSE, error=FALSE}
t <- 24 #nombre de mois que l'on veut afficher avant le forecast


ALL <- penit_to_ts("ALL", 2016)
x13_model <- ts_to_X13(ALL)
ts_fcst <- x13_model$regarima$forecast
ts_s<- tail(x13_model$final$series[,1], t)

s <- start(ts_s)
s <- paste(s[1],s[2], "01", sep = "-")
sd <- as.Date(str_to_time(s)) #date de début
ld <- sd %m+% months(t + 23)
df <- data.frame(date = seq(1, t), fcst = as.numeric(ts_s), stderr_fcst = NA) 
df2 <- data.frame(date = seq(t + 1, t + 24), fcst = as.numeric(ts_fcst[,1]), stderr_fcst = as.numeric(ts_fcst[,2]))
df <- df %>%
  rbind(df2) %>%
  mutate(date = seq(sd, ld, by = "month"))

ggplot(data = df, aes(x = date, y = fcst)) + 
  geom_line() + 
  labs(x = "Evolution mensuelle", y = "Nombre de détenus") +
  scale_x_continuous(breaks = seq(sd, ld, by = "3 month"), labels = seq(sd, ld, by = "3 month")) +
  theme(axis.text.x = element_text(angle = 305, vjust = 0.5)) +
  geom_ribbon( aes (ymin = fcst - stderr_fcst, ymax = fcst + stderr_fcst), alpha = 0.2)

summary(x13_model$regarima)
```




